<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!--[if IE]>
    <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sequence Predictor</title>
    <style>
        div.content {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        #sequence {
            width: 100%;
            box-sizing: border-box;
            -webkit-box-sizing:border-box;
            -moz-box-sizing: border-box;
        }

        #result {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="content">
    <h1>Sequences</h1>

    <div class="sequences">
        <input id="sequence" disabled="disabled"></textarea>
    </div>

    <p id="options">
        <input type="checkbox" id="function"/>
        <label for="function">Is actually a function</label>
    </p>


    <p id="status">Initializing...</p>

    <hr/>

    <div id="result">
        <p>$f(0) = 1$</p>

        <p>$f(1) = 4$</p>

        <p>$f(2) = 9$</p>

        <p>$f(3) = 16$</p>
    </div>
</div>

<div id="result">

</div>

<script src="jquery-2.1.1.min.js"></script>
<script src="underscore-min.js"></script>
<script src="mathjax/MathJax.js">
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["$","$"]]}
    });
</script>

<script>
    var Frac = function(a, b) {
        this.a = a;
        this.b = b;
    };

    var gcd = function(a, b) {
        a = Math.floor(a);
        b = Math.floor(b);
        while(b) {
            var c = a%b;
            a = b;
            b = c;
        }
        return a;
    }

    Frac.prototype.simplify = function() {
        if (this.isZero()) return new Frac(0, 1);
        var g = gcd(this.a, this.b);
        return new Frac(this.a/g, this.b/g);
    }

    Frac.prototype.add = function(that) {
        return new Frac(this.a*that.b+that.a*this.b, this.b*that.b).simplify();
    }

    Frac.prototype.neg = function() {
        return new Frac(-this.a, this.b);
    }

    Frac.prototype.sub = function(that) {
        return this.add(that.neg());
    }

    Frac.prototype.mul = function(that) {
        return new Frac(this.a*that.a, this.b*that.b).simplify();
    }

    Frac.prototype.inv = function() {
        return new Frac(this.b, this.a);
    }

    Frac.prototype.div = function(that) {
        return this.mul(that.inv());
    }

    Frac.prototype.isZero = function() {
        return Math.abs(this.a) < 1e-6;
    }

    Frac.prototype.toString = function() {
        if (Math.abs(this.b-1) < 1e-6) return this.a+'';
        return this.a + '/' + this.b;
    }


    var solve = function(sequence) {
        var V = [];
        var n = sequence.length;
        for(var i=0; i<n; i++) {
            var line = [];
            for(var j=0; j<n; j++)
                line.push(new Frac(Math.pow(i+1, j), 1));
            line.push(new Frac(sequence[i], 1));
            V.push(line);
        }
        console.log(sequence);
        console.table(V.map(function(v) { return v.map(function(x) { return x+'';});}));
        solveMatrix(V);
        console.table(V.map(function(v) { return v.map(function(x) { return x+'';});}));
    };

    var solveMatrix = function(V) {
        var m = V.length, n=m+1;
        for(var k=0; k<m; k++) {
            for(var i=k+1; i<m; i++) {
                var pivot = V[i][k].div(V[k][k]);
                for(var j=k; j<n; j++)
                    V[i][j] = V[i][j].sub(pivot.mul(V[k][j]));
            }
        }
        for(var i=m-1; i>=0; i--) {
            var pivot = V[i][i];
            if (pivot.isZero()) break;

            for(var j=i; j<n; j++) {
                V[i][j] = V[i][j].div(pivot);
            }

            for(var j=i+1; j<n-1; j++) {
                V[i][n-1] = V[i][n-1].sub(V[i][j].mul(V[j][n-1]));
                V[i][j] = new Frac(0, 1);
            }
        }
    }
    solve([1, 4, 9, 16]);

</script>

<script>
    var colorize = function () {
        var raw = $('#sequence').val();
        var func = $('#function').is(':checked');
        window.location.hash = [encodeURIComponent(raw), func].join('/');
        $('#status').text('Ready.');
    };

    var colorize2 = _.debounce(colorize, 500);
    var colorize3 = function () {
        $('#status').text('Waiting (use Ctrl+Enter to avoid debouncing)...');
        colorize2();
    };

    var triggerHash = function (first) {
        var hash = window.location.hash;
        if (hash.match(/^#/)) hash = hash.substr(1);
        var args = hash.split('/');
        args[0] = decodeURIComponent(args[0]);
        if (first && !hash)
            args[0] = args[0] || '1 4 9 16';
        var el0 = $('#sequence');
        var el1 = $('#function');
        var val1 = (args[1] || 'true') === 'true';
        if (first || el0.val() != args[0] || el1.is(':checked') != val1) {
            el0.val(args[0]);
            el1.prop('checked', val1);
            colorize();
        }
    };

    $(function () {
        $('#sequence').on('input', colorize3).on('keydown', function (e) {
            if (e.ctrlKey && e.keyCode == 13) {
                colorize();
                e.preventDefault();
            }
        }).prop('disabled', false);
        $('#function').on('click', colorize)
        $(window).on('hashchange', function () {
            triggerHash(false);
        });
        triggerHash(true);
    });
</script>
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-54080923-1', 'auto');
    ga('send', 'pageview');

</script>

</body>
</html>
